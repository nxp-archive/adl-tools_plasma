#!/usr/bin/env perl
# -- -*-perl-*-a
#
# Tests used in this regression.

use lib "..";
use lib ".";
use compile_check;
use rdriver;
use strict;
use Data::Dumper;

my @Tests = (
			 # 1. Basic check of multiple .c files.
			 {
			  cmd     => "./minicc -ast tests/in1.c tests/in2.c",
			  diff    => "tests/test1.out",
			 },
			 # 2. Checks that a parsing error will be reported.
			 {
			  cmd     => "./minicc -ast tests/in3.c",
			  diff    => "tests/test2.out",
			  stderr  => 1,
			  fail    => 1,
			 },
			 # 3. Large test of all supported features.
			 {
			  cmd     => "./minicc -ast tests/in4.c",
			  diff    => "tests/test3.out",
			 },
			 # 4. Simple symbol-table parsing.
			 {
			  cmd     => "./minicc -syms tests/in5.c",
			  diff    => "tests/test4.out",
			 },
			 # 5. Simple symbol-table parsing.
			 {
			  cmd     => "./minicc -syms tests/in6.c",
			  diff    => "tests/test5.out",
			  stderr  => 1,
			  fail    => 2,
			 },
			 # 6. Simple symbol-table parsing.
			 {
			  cmd     => "./minicc -syms tests/in7.c",
			  diff    => "tests/test6.out",
			  stderr  => 1,
			  fail    => 2,
			 },
			 # 7. Symbol table for big input file.
			 {
			  cmd     => "./minicc -syms tests/in4.c",
			  diff    => "tests/test10.out",
			 },
			 # 8. Type-checking test.
			 {
			  cmd     => "./minicc -check tests/in8.c",
			  diff    => "tests/test7.out",
			  stderr  => 1,
			  fail    => 2,
			 },			 
			 # 9. Type-checking test.
			 {
			  cmd     => "./minicc -check tests/in9.c",
			  diff    => "tests/test8.out",
			  stderr  => 1,
			  fail    => 2,
			 },
			 # 10. Flow control test.
			 {
			  cmd     => "./minicc -check tests/in10.c",
			  diff    => "tests/test9.out",
			  stderr  => 1,
			 },
			 # 11. Full check on multiple big input files (test should just not fail).
			 {
			  cmd     => "./minicc -check tests/in4.c tests/in4.c tests/in4.c tests/in4.c ",
			 },
			 # 12. Compilation of a large-ish program.
			 {
			  cmd     => "./minicc tests/foo.c tests/foo_lib.c",
			  checker => \&check_12,
			 },
	    );

# Do these only if we can compile on this platform.
if ($compile_check::CompileOk) {
  push @Tests,{
			   cmd    => "./foo 1 2 hello 3",
			   diff    => "tests/test11.out",
			  };
}

doTest(\@Tests);

##
## <TESTS>
##

sub check_12 {
  compare_asm_file("foo_lib.s","tests/foo_lib.good");
  compare_asm_file("foo.s","tests/foo.good");
};

sub compare_asm_file {
  my $fn = shift;
  my $cmp = shift;

  my @input;
  open my $in,$fn or die "Could not open $fn";
  @input = (<$in>);
  my $str = join "",@input;
  if (!doDiff($str,$cmp,0,"#")) {
	die "Failed diff.";
  }
  close $in;
}

##
## </TESTS>
##
