
TESTS = regress

if CompileOk
PROG = foo
else
PROG = 
endif

check_PROGRAMS = minicc $(PROG)

minicc_SOURCES = \
	String.C \
	Node.C \
	SymTab.C \
	StackMachine.C \
	AsmStore.C \
	main.pa \
	CParser.pa \
	Compiler.pa \
	CodeGen.pa \
	cparse.yy \
	CLexer.pa \
	clex.ll

minicc_DEPENDENCIES = $(DEPENDENCIES)

DEP_FILES=\
	./$(DEPDIR)/main.Po \
	./$(DEPDIR)/String.Po \
	./$(DEPDIR)/CLexer.Po \
	./$(DEPDIR)/CParser.Po \
	./$(DEPDIR)/Compiler.Po \
	./$(DEPDIR)/CodeGen.Po \
	./$(DEPDIR)/AsmStore.Po \
	./$(DEPDIR)/cparse.Po \
	./$(DEPDIR)/clex.Po \
	./$(DEPDIR)/Node.Po \
	./$(DEPDIR)/SymTab.Po
	./$(DEPDIR)/StackMachine.Po

include ./$(DEPDIR)/main.Po
include ./$(DEPDIR)/CLexer.Po
include ./$(DEPDIR)/CParser.Po
include ./$(DEPDIR)/Compiler.Po
include ./$(DEPDIR)/CodeGen.Po

BUILT_SOURCES = clex.cc

LEMON = ../lemon/lemon

AM_CXXFLAGS = -I$(top_srcdir)/gc/include

minicc_LDFLAGS = -L$(top_srcdir)/gc -Wl,-R$(top_srcdir)/gc/.libs

minicc_LDADD =  -lgc -ldl

clex_lflag = -Cfe

foo: tests/foo.c tests/foo_lib.c minicc
	./minicc $(filter %.c,$^)
	$(CXX) -o $@ $(notdir $(patsubst %.c,%.s,$(filter %.c,$^)))

%.cc : %.ll ;
	$(LEX) $($(patsubst %.cc,%_lflag,$(@))) -o$@ $(@:.cc=.ll)

%.cc : %.yy ;
	$(LEMON) $<

cparse.h: cparse.cc
CLexer.o: cparse.h
clex.o: cparse.h
# Explicit dependency b/c this header file is generated by lemon.
Node.o: cparse.h

include $(top_srcdir)/tests/Makefile.rules

# For some stupid reason, Automake thinks that this is a C++ project, so
# I have to fool it here.
CXXLINK = $(PLASMA) -o $@

CLEANFILES += clex.cc cparse.cc cparse.h *.s

