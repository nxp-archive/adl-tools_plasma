<!-- 95% W3C COMPLIANT, 95% CSS FREE, RAW HTML -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
<title>Example Source Code</title>
 <style type="text/css">
  <!--
  pre { font-family: monospace }
  tt { font-family: monospace }
  code { font-family: monospace }
  p.flushright { text-align: right }
  p.flushleft { text-align: left }
  span.sc { font-variant: small-caps }
  span.sf { font-family: sans-serif }
  span.skribetitle { font-family: sans-serif; font-weight: bolder; font-size: x-large; }
  -->
 </style>
</head>

<body class="section" bgcolor="#ffffff">
<table width="100%" class="skribetitle" cellspacing="0" cellpadding="0"><tbody>
<tr><td align="center" bgcolor="#8381de"><div class="skribetitle"><strong><big><big><big>2 Example Source Code -- RISC Pipeline Example 2</big></big></big></strong></div><center>
</center>
</td></tr></tbody></table>
<table cellpadding="3" cellspacing="0" width="100%" class="skribe-margins"><tr>
<td align="left" valign="top" class="skribe-left-margin" width="20%" bgcolor="#dedeff"><div class="skribe-left-margin">
<br/><center><table width="97%" border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse;" frame="box" rules="none"><tbody>
<tr bgcolor="#8381de"><th align="center" colspan="1"><font color="#ffffff"><strong>main page</strong></font></th></tr>
<tr bgcolor="#ffffff"><td align="center" colspan="1"><table width="100%" border="0" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td align="left" valign="top" colspan="1"><strong>top:</strong></td><td align="right" valign="top" colspan="1"><a href="source-code.html#Example-Source-Code" class="inbound">Example Source Code</a></td></tr>
</tbody></table>
</td></tr>
</tbody></table>
</center>
<br/><br/><center><table width="97%" border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse;" frame="box" rules="none"><tbody>
<tr bgcolor="#8381de"><th align="center" colspan="1"><font color="#ffffff"><strong>Sections</strong></font></th></tr>
<tr bgcolor="#ffffff"><td align="center" colspan="1"><table cellspacing="1" cellpadding="1" width="100%" class="toc">
<tbody>
 <tr><td valign="top" align="left">1</td><td colspan="4" width="100%"><a href="source-code-1.html#RISC-Pipeline-Example">RISC Pipeline Example</a></td></tr>
 <tr><td></td><td valign="top" align="left">1.1</td><td colspan="3" width="100%"><a href="source-code-1.html#sw/pipe.pa">sw/pipe.pa</a></td></tr>
 <tr><td valign="top" align="left">2</td><td colspan="4" width="100%"><a href="source-code-2.html#RISC-Pipeline-Example-2">RISC Pipeline Example 2</a></td></tr>
 <tr><td></td><td valign="top" align="left">2.1</td><td colspan="3" width="100%"><a href="source-code-2.html#../doc/pipe2.pa">../doc/pipe2.pa</a></td></tr>
 <tr><td valign="top" align="left">3</td><td colspan="4" width="100%"><a href="source-code-3.html#Network-System-Example">Network System Example</a></td></tr>
 <tr><td></td><td valign="top" align="left">3.1</td><td colspan="3" width="100%"><a href="source-code-3.html#eav/eav.pa">eav/eav.pa</a></td></tr>
 <tr><td valign="top" align="left">4</td><td colspan="4" width="100%"><a href="source-code-4.html#Embedded-Application-Example">Embedded Application Example</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.1</td><td colspan="3" width="100%"><a href="source-code-4.html#Header-Files">Header Files</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.2</td><td colspan="3" width="100%"><a href="source-code-4.html#Implementation-Files">Implementation Files</a></td></tr>
 <tr><td valign="top" align="left">5</td><td colspan="4" width="100%"><a href="source-code-5.html#Desktop-Application-Example">Desktop Application Example</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.1</td><td colspan="3" width="100%"><a href="source-code-5.html#Main-Program">Main Program</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.2</td><td colspan="3" width="100%"><a href="source-code-5.html#Compiler-Driver">Compiler Driver</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.3</td><td colspan="3" width="100%"><a href="source-code-5.html#Lexer">Lexer</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.4</td><td colspan="3" width="100%"><a href="source-code-5.html#Parser">Parser</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.5</td><td colspan="3" width="100%"><a href="source-code-5.html#"></a></td></tr>
 <tr><td></td><td valign="top" align="left">5.6</td><td colspan="3" width="100%"><a href="source-code-5.html#Symbol-Table">Symbol Table</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.7</td><td colspan="3" width="100%"><a href="source-code-5.html#Code-Generation">Code Generation</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.8</td><td colspan="3" width="100%"><a href="source-code-5.html#Register-Allocation">Register Allocation</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.9</td><td colspan="3" width="100%"><a href="source-code-5.html#Assembly-Code-Writer">Assembly Code Writer</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.10</td><td colspan="3" width="100%"><a href="source-code-5.html#String-Class">String Class</a></td></tr>
 <tr><td></td><td valign="top" align="left">5.11</td><td colspan="3" width="100%"><a href="source-code-5.html#Miscellaneous-Headers">Miscellaneous Headers</a></td></tr>
</tbody>
</table>
</td></tr>
</tbody></table>
</center>
</div></td>
<td align="left" valign="top" class="skribe-body"><div class="skribe-body">
<!-- ../doc/pipe2.pa -->
<a name="../doc/pipe2.pa"></a>
<div class="skribesubsectiontitle"><table width="100%"><tr><td bgcolor="#ffffff"><h3><font color="#8381de">2.1 ../doc/pipe2.pa</font>
</h3></td></tr></table>
</div><div class="subsection">
<table cellspacing="0" class="color" cellpadding="0"><tbody>
<tr><td bgcolor="#ffffcc"><table cellspacing="0" class="frame" cellpadding="2" border="1" width="100%"><tbody>
<tr><td><pre class="prog"><em>  1: </em><font color="#ffa600"><em>//</em></font>
<em>  2: </em><font color="#ffa600"><em>// Simple 5-stage DLX pipeline.</em></font>
<em>  3: </em><font color="#ffa600"><em>//</em></font>
<em>  4: </em>
<em>  5: </em><font color="#1919af"><strong>#include</strong></font> &lt;iostream&gt;
<em>  6: </em>
<em>  7: </em><font color="#1919af"><strong>#include</strong></font> <font color="red">&quot;plasma/plasma.h&quot;</font>
<em>  8: </em>
<em>  9: </em><font color="#1919af"><strong>#include</strong></font> <font color="red">&quot;helpers.h&quot;</font>
<em> 10: </em><font color="#1919af"><strong>#include</strong></font> <font color="red">&quot;NoBlock.h&quot;</font>
<em> 11: </em><font color="#1919af"><strong>#include</strong></font> <font color="red">&quot;dlx.h&quot;</font>
<em> 12: </em>
<em> 13: </em>using namespace std;
<em> 14: </em>using namespace plasma;
<em> 15: </em>using namespace dlx;
<em> 16: </em>  
<em> 17: </em><strong>typedef</strong> NoBlockChan&lt;instr_t&gt;     NbInstChan;
<em> 18: </em><strong>typedef</strong> ClockChan&lt;int&gt;           ClkIntChan;
<em> 19: </em><strong>typedef</strong> ClockChan&lt;instr_t&gt;       ClkInstChan;
<em> 20: </em>
<em> 21: </em><font color="#ffa600"><em>// The architecture- global for now.</em></font>
<em> 22: </em>DLX arch;
<em> 23: </em>
<em> 24: </em><font color="#ffa600"><em>// A tick of 10 units   </em></font>
<em> 25: </em>const int Clock = 10;
<em> 26: </em>
<em> 27: </em><font color="#ffa600"><em>// Command-line options.</em></font>
<em> 28: </em>Options options;
<em> 29: </em>
<em> 30: </em><font color="#ffa600"><em>// Start time of simulation.</em></font>
<em> 31: </em>ptime_t starttime = 0;
<em> 32: </em>
<em> 33: </em><font color="#ffa600"><em>// Stage identifiers.</em></font>
<em> 34: </em>const int FetchStage = 0;
<em> 35: </em>const int DecodeStage = 1;
<em> 36: </em>const int ExecStage = 2;
<em> 37: </em>const int MemStage = 3;
<em> 38: </em>const int WritebackStage = 4;
<em> 39: </em>
<em> 40: </em><font color="#ffa600"><em>// Instruction classes.</em></font>
<em> 41: </em>const int Load   = 0x0001;
<em> 42: </em>const int Store  = 0x0002;
<em> 43: </em>const int Branch = 0x0004;
<em> 44: </em>
<em> 45: </em><font color="#ffa600"><em>// This delays by one clock cycle.</em></font>
<em> 46: </em>void atclock(int n = 1)
<em> 47: </em><font color="red"><strong>{</strong></font>
<em> 48: </em>  pDelay(Clock * n);
<em> 49: </em><font color="red"><strong>}</strong></font>
<em> 50: </em>
<em> 51: </em><font color="#ffa600"><em>// This creates a pipeline bubble by</em></font>
<em> 52: </em><font color="#ffa600"><em>// stalling a stage for a clock cycle.</em></font>
<em> 53: </em>void stall(int n,ClkInstChan &amp;chan)
<em> 54: </em><font color="red"><strong>{</strong></font>
<em> 55: </em>  <strong>for</strong> (int i = 0; i != n; ++i) <font color="red"><strong>{</strong></font>
<em> 56: </em>    chan.write(instr_t());
<em> 57: </em>    pDelay(Clock);
<em> 58: </em>  <font color="red"><strong>}</strong></font>
<em> 59: </em><font color="red"><strong>}</strong></font>
<em> 60: </em>
<em> 61: </em><font color="#ffa600"><em>//</em></font>
<em> 62: </em><font color="#ffa600"><em>// Start of micro-architecture description.</em></font>
<em> 63: </em><font color="#ffa600"><em>//</em></font>
<em> 64: </em>        
<em> 65: </em>void fetch(NbInstChan &amp;prev_chan,ClkInstChan &amp;branch_update, 
<em> 66: </em>           ClkIntChan &amp;refetch_chan, ClkInstChan &amp;out)
<em> 67: </em><font color="red"><strong>{</strong></font>
<em> 68: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em> 69: </em>    atclock();
<em> 70: </em>
<em> 71: </em>    instr_t bupdate = (branch_update.ready()) ? branch_update.get() : 0;
<em> 72: </em>    instr_t instr = arch.fetch(bupdate);
<em> 73: </em>    update_pipe_report(FetchStage,instr);
<em> 74: </em>    instr_t prev = prev_chan.get();
<em> 75: </em>
<em> 76: </em>    int refetch = (refetch_chan.ready()) ? refetch_chan.get() : 0;
<em> 77: </em>    <strong>if</strong> (prev.is_of_class(Branch)) <font color="red"><strong>{</strong></font>
<em> 78: </em>      refetch = true;
<em> 79: </em>    <font color="red"><strong>}</strong></font>
<em> 80: </em>
<em> 81: </em>    prev_chan.write(instr); 
<em> 82: </em>    <strong>if</strong> (instr.is_of_class(Branch) || refetch) <font color="red"><strong>{</strong></font>
<em> 83: </em>      <font color="#ffa600"><em>// This is just needed to keep us from fetching past a branch</em></font>
<em> 84: </em>      <font color="#ffa600"><em>// until we know the target.  This mainly just matters to avoid</em></font>
<em> 85: </em>      <font color="#ffa600"><em>// fetching past a halt.</em></font>
<em> 86: </em>      arch.incr_iar(-4);
<em> 87: </em>    <font color="red"><strong>}</strong></font>      
<em> 88: </em>    <strong>if</strong> (refetch) <font color="red"><strong>{</strong></font>
<em> 89: </em>      prev_chan.write(instr_t()); 
<em> 90: </em>      <strong>continue</strong>;
<em> 91: </em>    <font color="red"><strong>}</strong></font>
<em> 92: </em>
<em> 93: </em>    out.write(instr);
<em> 94: </em>  <font color="red"><strong>}</strong></font>
<em> 95: </em><font color="red"><strong>}</strong></font>
<em> 96: </em>
<em> 97: </em>void decode(ClkInstChan &amp;in, ClkIntChan &amp;refetch_chan, ClkInstChan &amp;branch_update,
<em> 98: </em>            NbInstChan &amp;prev_chan, NbInstChan &amp;exec_fwd, NbInstChan &amp;mem_fwd, 
<em> 99: </em>            ClkInstChan &amp;out)
<em>100: </em><font color="red"><strong>{</strong></font>
<em>101: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>102: </em>    instr_t instr = in.get();
<em>103: </em>    update_pipe_report(DecodeStage,instr);
<em>104: </em>
<em>105: </em>    <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>106: </em>      arch.read_operands(instr);
<em>107: </em>      instr_t prev  = prev_chan.get();
<em>108: </em>      instr_t exec  = exec_fwd.get();
<em>109: </em>      instr_t mem   = mem_fwd.get();
<em>110: </em>
<em>111: </em>      <font color="#ffa600"><em>// Check for stalls here:</em></font>
<em>112: </em>      <font color="#ffa600"><em>//  Prior instruction is a load and our op uses the target.</em></font>
<em>113: </em>      <font color="#ffa600"><em>//  This instruction is a branch and op uses prior target.</em></font>
<em>114: </em>      <strong>if</strong> (prev.is_of_class(Load) &amp;&amp; arch.operand_conflict(instr,prev)) <font color="red"><strong>{</strong></font>
<em>115: </em>        <font color="#ffa600"><em>// Insert bubble.</em></font>
<em>116: </em>        stall(1,out);
<em>117: </em>        <font color="#ffa600"><em>// Issue instruction.</em></font>
<em>118: </em>        prev_chan.write(instr);
<em>119: </em>        out.write(instr);
<em>120: </em>        <font color="#ffa600"><em>// Go to next cycle.</em></font>
<em>121: </em>        atclock();
<em>122: </em>        <strong>break</strong>;
<em>123: </em>      <font color="red"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> (instr.is_of_class(Branch) ) <font color="red"><strong>{</strong></font>
<em>124: </em>        <strong>if</strong> (arch.operand_conflict(instr,prev)) <font color="red"><strong>{</strong></font>
<em>125: </em>          refetch_chan.write(1);
<em>126: </em>          prev_chan.write(instr_t());
<em>127: </em>          stall(1,out);
<em>128: </em>          <strong>continue</strong>;
<em>129: </em>        <font color="red"><strong>}</strong></font>
<em>130: </em>      <font color="red"><strong>}</strong></font>
<em>131: </em>      <font color="#ffa600"><em>// Branches update the iar in decode.</em></font>
<em>132: </em>      <strong>if</strong> (instr.is_of_class(Branch)) <font color="red"><strong>{</strong></font>
<em>133: </em>        arch.update_from_fwd(instr,exec);
<em>134: </em>        arch.update_from_fwd(instr,mem);
<em>135: </em>        arch.exec(instr);
<em>136: </em>        branch_update.write(instr);
<em>137: </em>      <font color="red"><strong>}</strong></font>
<em>138: </em>      <font color="#ffa600"><em>// Normal condition- pass data to next stage.</em></font>
<em>139: </em>      prev_chan.write(instr);
<em>140: </em>      out.write(instr);
<em>141: </em>      <strong>break</strong>;
<em>142: </em>    <font color="red"><strong>}</strong></font>
<em>143: </em>  <font color="red"><strong>}</strong></font>
<em>144: </em><font color="red"><strong>}</strong></font>
<em>145: </em>
<em>146: </em>void exec(ClkInstChan &amp;in, NbInstChan &amp;mem_fwd_chan, 
<em>147: </em>          NbInstChan &amp;exec_fwd_chan, NbInstChan &amp;decode_fwd_chan, 
<em>148: </em>          ClkInstChan &amp;out)
<em>149: </em><font color="red"><strong>{</strong></font>
<em>150: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>151: </em>    instr_t instr = in.get();
<em>152: </em>    update_pipe_report(ExecStage,instr);
<em>153: </em>    instr_t mem_fwd = mem_fwd_chan.get();
<em>154: </em>    instr_t exec_fwd = exec_fwd_chan.get();
<em>155: </em>    arch.update_from_fwd(instr,exec_fwd);
<em>156: </em>    arch.update_from_fwd(instr,mem_fwd);
<em>157: </em>    <strong>if</strong> (!instr.is_of_class(Load | Store)) <font color="red"><strong>{</strong></font>
<em>158: </em>      arch.exec(instr);
<em>159: </em>    <font color="red"><strong>}</strong></font>
<em>160: </em>    out.write(instr);
<em>161: </em>    exec_fwd_chan.write(instr);
<em>162: </em>    decode_fwd_chan.write(instr);
<em>163: </em>  <font color="red"><strong>}</strong></font>
<em>164: </em><font color="red"><strong>}</strong></font>
<em>165: </em>
<em>166: </em>void mem(ClkInstChan &amp;in,NbInstChan &amp;decode_fwd_chan,NbInstChan &amp;exec_fwd_chan,
<em>167: </em>         NbInstChan &amp;mem_fwd_chan,ClkInstChan &amp;out) 
<em>168: </em><font color="red"><strong>{</strong></font>
<em>169: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>170: </em>    instr_t instr = in.get();
<em>171: </em>    update_pipe_report(MemStage,instr);
<em>172: </em>    instr_t mem_fwd = mem_fwd_chan.get();
<em>173: </em>    arch.update_from_fwd(instr,mem_fwd);
<em>174: </em>    arch.exec(instr);
<em>175: </em>    out.write(instr);
<em>176: </em>    decode_fwd_chan.write(instr);
<em>177: </em>    exec_fwd_chan.write(instr);
<em>178: </em>    mem_fwd_chan.write(instr);
<em>179: </em>  <font color="red"><strong>}</strong></font>
<em>180: </em><font color="red"><strong>}</strong></font>
<em>181: </em>
<em>182: </em>void writeback(ClkInstChan &amp;in)
<em>183: </em><font color="red"><strong>{</strong></font>
<em>184: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>185: </em>    instr_t instr = in.get();
<em>186: </em>    update_pipe_report(WritebackStage,instr);
<em>187: </em>    arch.commit(instr);
<em>188: </em>  <font color="red"><strong>}</strong></font>
<em>189: </em><font color="red"><strong>}</strong></font>
<em>190: </em>
<em>191: </em><font color="#ffa600"><em>//</em></font>
<em>192: </em><font color="#ffa600"><em>// Start of setup code.</em></font>
<em>193: </em><font color="#ffa600"><em>//</em></font>
<em>194: </em>    
<em>195: </em>void hangup();
<em>196: </em>
<em>197: </em>void microarch_setup()
<em>198: </em><font color="red"><strong>{</strong></font>
<em>199: </em>  arch.set_instr_class(<font color="red">&quot;lb&quot;</font>, Load);
<em>200: </em>  arch.set_instr_class(<font color="red">&quot;lbu&quot;</font>,Load);
<em>201: </em>  arch.set_instr_class(<font color="red">&quot;ld&quot;</font>, Load);
<em>202: </em>  arch.set_instr_class(<font color="red">&quot;lf&quot;</font>, Load);
<em>203: </em>  arch.set_instr_class(<font color="red">&quot;lh&quot;</font>, Load);
<em>204: </em>  arch.set_instr_class(<font color="red">&quot;lhu&quot;</font>,Load);
<em>205: </em>  arch.set_instr_class(<font color="red">&quot;lw&quot;</font>, Load);
<em>206: </em>  arch.set_instr_class(<font color="red">&quot;sb&quot;</font>, Store);
<em>207: </em>  arch.set_instr_class(<font color="red">&quot;sd&quot;</font>, Store);
<em>208: </em>  arch.set_instr_class(<font color="red">&quot;sf&quot;</font>, Store);
<em>209: </em>  arch.set_instr_class(<font color="red">&quot;sh&quot;</font>, Store);
<em>210: </em>  arch.set_instr_class(<font color="red">&quot;sw&quot;</font>, Store);
<em>211: </em>  arch.set_instr_class(<font color="red">&quot;beqz&quot;</font>, Branch);
<em>212: </em>  arch.set_instr_class(<font color="red">&quot;bfpf&quot;</font>, Branch);
<em>213: </em>  arch.set_instr_class(<font color="red">&quot;bfpt&quot;</font>, Branch);
<em>214: </em>  arch.set_instr_class(<font color="red">&quot;bnez&quot;</font>, Branch);
<em>215: </em>  arch.set_instr_class(<font color="red">&quot;j&quot;</font>,    Branch);
<em>216: </em>  arch.set_instr_class(<font color="red">&quot;jal&quot;</font>,  Branch); 
<em>217: </em>  arch.set_instr_class(<font color="red">&quot;jalr&quot;</font>, Branch);
<em>218: </em>  arch.set_instr_class(<font color="red">&quot;jr&quot;</font>,   Branch);
<em>219: </em>  arch.set_instr_class(<font color="red">&quot;halt&quot;</font>, Branch);
<em>220: </em>  arch.set_halt_func(hangup);
<em>221: </em>
<em>222: </em>  set_stage_name(FetchStage,    <font color="red">&quot;fetch    &quot;</font>);
<em>223: </em>  set_stage_name(DecodeStage,   <font color="red">&quot;decode   &quot;</font>);
<em>224: </em>  set_stage_name(ExecStage,     <font color="red">&quot;exec     &quot;</font>);
<em>225: </em>  set_stage_name(MemStage,      <font color="red">&quot;mem      &quot;</font>);
<em>226: </em>  set_stage_name(WritebackStage,<font color="red">&quot;writeback&quot;</font>);
<em>227: </em><font color="red"><strong>}</strong></font>
<em>228: </em>
<em>229: </em><font color="#ffa600"><em>// Watchdog timer stops the simulation after a specified amount of time.</em></font>
<em>230: </em>void watchdog() 
<em>231: </em><font color="red"><strong>{</strong></font>
<em>232: </em>  ptime_t n = (options._timeout == 0) ? 10000 : options._timeout;
<em>233: </em>  cout &lt;&lt; <font color="red">&quot;\nTimeout is &quot;</font> &lt;&lt; n &lt;&lt; <font color="red">&quot; cycles\n\n&quot;</font>;
<em>234: </em>  n *= Clock;
<em>235: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>236: </em>    atclock(10);
<em>237: </em>    printf(<font color="red">&quot;.&quot;</font>);
<em>238: </em>    <strong>if</strong> (pTime() &gt; n) <font color="red"><strong>{</strong></font>
<em>239: </em>      cout &lt;&lt; <font color="red">&quot;\nStopping- timeout at &quot;</font> &lt;&lt; pTime() &lt;&lt; endl;
<em>240: </em>      pExit(1);
<em>241: </em>    <font color="red"><strong>}</strong></font>
<em>242: </em>  <font color="red"><strong>}</strong></font>
<em>243: </em><font color="red"><strong>}</strong></font>
<em>244: </em>
<em>245: </em><font color="#ffa600"><em>// This function is called when the machine is halted.</em></font>
<em>246: </em>void hangup()
<em>247: </em><font color="red"><strong>{</strong></font>
<em>248: </em>  <strong>if</strong> (options._ep) <font color="red"><strong>{</strong></font>
<em>249: </em>    cout &lt;&lt; <font color="red">&quot;\n&lt;STATE&gt;\n&quot;</font>;
<em>250: </em>    arch.print_state(cout,true);
<em>251: </em>    cout &lt;&lt; <font color="red">&quot;\n&quot;</font>;
<em>252: </em>    arch.print_mem(cout,true);
<em>253: </em>    cout &lt;&lt; <font color="red">&quot;&lt;/STATE&gt;\n&quot;</font>;
<em>254: </em>  <font color="red"><strong>}</strong></font> <strong>else</strong> <font color="red"><strong>{</strong></font>
<em>255: </em>    <font color="#ffa600"><em>// Make sure that there's a final pipeline report.</em></font>
<em>256: </em>    <strong>if</strong> (options._pr) <font color="red"><strong>{</strong></font>
<em>257: </em>      pipe_report(cout,0);
<em>258: </em>    <font color="red"><strong>}</strong></font>
<em>259: </em>    ptime_t finishtime = getusec();
<em>260: </em>    double secs = (finishtime-starttime)/1000000;
<em>261: </em>    cout &lt;&lt; <font color="red">&quot;\n\n&quot;</font>
<em>262: </em>         &lt;&lt; <font color="red">&quot;End of simulation at time &quot;</font> &lt;&lt; dec &lt;&lt; pTime() &lt;&lt; <font color="red">&quot;\n&quot;</font>
<em>263: </em>         &lt;&lt; <font color="red">&quot;Number of fetches:  &quot;</font> &lt;&lt; arch.get_num_fetches() &lt;&lt; <font color="red">&quot;\n&quot;</font>
<em>264: </em>         &lt;&lt; <font color="red">&quot;Number of commits:  &quot;</font> &lt;&lt; arch.get_num_commits() &lt;&lt; <font color="red">&quot;\n&quot;</font>
<em>265: </em>         &lt;&lt; <font color="red">&quot;Elapsed time:       &quot;</font> &lt;&lt; secs &lt;&lt; <font color="red">&quot;s\n&quot;</font>
<em>266: </em>         &lt;&lt; <font color="red">&quot;Instruction/sec:   &quot;</font> &lt;&lt;  arch.get_num_commits()/secs &lt;&lt; <font color="red">&quot;\n&quot;</font>;
<em>267: </em>    arch.print_state(cout);
<em>268: </em>    cout &lt;&lt; <font color="red">&quot;\n&quot;</font>;
<em>269: </em>    arch.print_mem(cout);
<em>270: </em>  <font color="red"><strong>}</strong></font>
<em>271: </em>  pExit(0);
<em>272: </em><font color="red"><strong>}</strong></font>
<em>273: </em>
<em>274: </em>int pipeline_report(unsigned delay) 
<em>275: </em><font color="red"><strong>{</strong></font>
<em>276: </em>  pDelay(delay);
<em>277: </em>  <strong>while</strong> (true) <font color="red"><strong>{</strong></font>
<em>278: </em>    atclock();
<em>279: </em>    pipe_report(cout,delay);
<em>280: </em>  <font color="red"><strong>}</strong></font>
<em>281: </em>  <strong>return</strong> 0;
<em>282: </em><font color="red"><strong>}</strong></font>
<em>283: </em>
<em>284: </em><font color="#ffa600"><em>// Shut off preemption.</em></font>
<em>285: </em>void pSetup(ConfigParms &amp;cp)
<em>286: </em><font color="red"><strong>{</strong></font>
<em>287: </em>  cp._busyokay = true;
<em>288: </em><font color="red"><strong>}</strong></font>
<em>289: </em>
<em>290: </em>bool init(int argc,const char *argv[])
<em>291: </em><font color="red"><strong>{</strong></font>
<em>292: </em>  printf(<font color="red">&quot;\n\n\n\n&quot;</font>
<em>293: </em>         <font color="red">&quot;Simple 5-stage DLX pipeline\n&quot;</font>);
<em>294: </em>
<em>295: </em>  <strong>if</strong> (!process_args(options,argc,argv)) <font color="red"><strong>{</strong></font>
<em>296: </em>    <strong>return</strong> false;
<em>297: </em>  <font color="red"><strong>}</strong></font>
<em>298: </em>  
<em>299: </em>  <strong>if</strong> (!load_files(arch,options._files)) <font color="red"><strong>{</strong></font>
<em>300: </em>    <strong>return</strong> false;
<em>301: </em>  <font color="red"><strong>}</strong></font>
<em>302: </em>
<em>303: </em>  <strong>if</strong> (options._pr) <font color="red"><strong>{</strong></font>
<em>304: </em>    spawn(pipeline_report(1));
<em>305: </em>  <font color="red"><strong>}</strong></font>
<em>306: </em>
<em>307: </em>  microarch_setup();
<em>308: </em>
<em>309: </em>  printf(<font color="red">&quot;\nCode and registers initialised.&quot;</font>);
<em>310: </em>  <strong>return</strong> true;
<em>311: </em><font color="red"><strong>}</strong></font>
<em>312: </em>
<em>313: </em>int pMain(int argc,const char *argv[]) 
<em>314: </em><font color="red"><strong>{</strong></font>
<em>315: </em>  <strong>if</strong> (!init(argc,argv)) <font color="red"><strong>{</strong></font>
<em>316: </em>    <strong>return</strong> usage(argv[0]);
<em>317: </em>  <font color="red"><strong>}</strong></font>
<em>318: </em>
<em>319: </em>  starttime = getusec();
<em>320: </em>
<em>321: </em>  <font color="#ffa600"><em>//</em></font>
<em>322: </em>  <font color="#ffa600"><em>// Define the communication channels.</em></font>
<em>323: </em>  <font color="#ffa600"><em>// </em></font>
<em>324: </em>
<em>325: </em>  ClkInstChan 
<em>326: </em>    fetch2decode(Clock),
<em>327: </em>    br_decode2fetch(Clock),
<em>328: </em>    decode2exec(Clock),
<em>329: </em>    exec2mem(Clock),
<em>330: </em>    mem2wb(Clock/2);
<em>331: </em>
<em>332: </em>  NbInstChan
<em>333: </em>    fetch2fetch(Clock),
<em>334: </em>    decode2decode(Clock),
<em>335: </em>    exec2decode(Clock),
<em>336: </em>    exec2exec(Clock),
<em>337: </em>    mem2decode(Clock),
<em>338: </em>    mem2exec(Clock),
<em>339: </em>    mem2mem(Clock);
<em>340: </em>
<em>341: </em>  ClkIntChan
<em>342: </em>    decode2fetch(Clock);
<em>343: </em>
<em>344: </em>  <font color="#ffa600"><em>//</em></font>
<em>345: </em>  <font color="#ffa600"><em>// Define the connectivity and launch each thread.</em></font>
<em>346: </em>  <font color="#ffa600"><em>//</em></font>
<em>347: </em>  par <font color="red"><strong>{</strong></font>
<em>348: </em>    <font color="red"><strong>{</strong></font>
<em>349: </em>      <strong>if</strong> (!options._nw) watchdog();
<em>350: </em>    <font color="red"><strong>}</strong></font>
<em>351: </em>    fetch(fetch2fetch,br_decode2fetch,decode2fetch,fetch2decode);
<em>352: </em>    decode(fetch2decode,decode2fetch,br_decode2fetch,decode2decode,exec2decode,mem2decode,decode2exec);
<em>353: </em>    exec(decode2exec,mem2exec,exec2exec,exec2decode,exec2mem);
<em>354: </em>    mem(exec2mem,mem2decode,mem2exec,mem2mem,mem2wb);
<em>355: </em>    writeback(mem2wb);
<em>356: </em>  <font color="red"><strong>}</strong></font>
<em>357: </em>
<em>358: </em>  <font color="#ffa600"><em>// We never get here- the watchdog stops the simulation.</em></font>
<em>359: </em>  <strong>return</strong> 0;
<em>360: </em><font color="red"><strong>}</strong></font>
</pre>
</td></tr>
</tbody></table></td></tr>
</tbody></table></div>
</div></td>
</tr></table><div class="skribe-ending">
<hr> 
<p class="ending"><font size="-1">
This <span class="sc">Html</span> page has been produced by 
<a href="http://www.inria.fr/mimosa/fp/Skribe" class="http">Skribe</a>.
<br/>
Last update <em>Wed Nov  9 16:42:01 2005</em>.</font></p></div>
</body>
</html>